
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Running a minimal DaVinci job locally Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="The Starterkit team and contributors">
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-panels/panels.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-katex-auto-render/katex.min.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="loki-functors.html" />
    
    
    <link rel="prev" href="interactive-dst.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    The LHCb Starterkit
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.1" data-path="../CONTRIBUTING.html">
            
                <a href="../CONTRIBUTING.html">
            
                    
                    Contributing
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="./">
            
                <a href="./">
            
                    
                    First analysis steps
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.1" data-path="prerequisites.html">
            
                <a href="prerequisites.html">
            
                    
                    Pre-workshop checklist
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.2" data-path="introduction-to-course.html">
            
                <a href="introduction-to-course.html">
            
                    
                    Goals of the course
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.3" data-path="physics-at-lhcb.html">
            
                <a href="physics-at-lhcb.html">
            
                    
                    Physics at LHCb
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.4" data-path="dataflow.html">
            
                <a href="dataflow.html">
            
                    
                    The LHCb data flow
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.5" data-path="run-2-data-flow.html">
            
                <a href="run-2-data-flow.html">
            
                    
                    Changes to the data flow in Run 2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.6" data-path="davinci.html">
            
                <a href="davinci.html">
            
                    
                    An introduction to LHCb Software
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.7" data-path="bookkeeping.html">
            
                <a href="bookkeeping.html">
            
                    
                    Finding data in the Bookkeeping
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.8" data-path="files-from-grid.html">
            
                <a href="files-from-grid.html">
            
                    
                    Downloading a file from the grid
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.9" data-path="interactive-dst.html">
            
                <a href="interactive-dst.html">
            
                    
                    Interactively exploring a DST
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="2.1.10" data-path="minimal-dv-job.html">
            
                <a href="minimal-dv-job.html">
            
                    
                    Running a minimal DaVinci job locally
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.11" data-path="loki-functors.html">
            
                <a href="loki-functors.html">
            
                    
                    Fun with LoKi Functors
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.12" data-path="add-tupletools.html">
            
                <a href="add-tupletools.html">
            
                    
                    TupleTools and branches
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.13" data-path="decay-tree-fitter.html">
            
                <a href="decay-tree-fitter.html">
            
                    
                    How do I use DecayTreeFitter?
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.14" data-path="davinci-grid.html">
            
                <a href="davinci-grid.html">
            
                    
                    Running DaVinci on the grid
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.15" data-path="split-jobs.html">
            
                <a href="split-jobs.html">
            
                    
                    Splitting a job into subjobs
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.16" data-path="ganga-data.html">
            
                <a href="ganga-data.html">
            
                    
                    More Ganga
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.17" data-path="eos-storage.html">
            
                <a href="eos-storage.html">
            
                    
                    Storing large files on EOS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.18" data-path="lhcb-dev.html">
            
                <a href="lhcb-dev.html">
            
                    
                    Developing LHCb Software
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.19" data-path="asking-questions.html">
            
                <a href="asking-questions.html">
            
                    
                    Asking good questions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.20" data-path="ecgd.html">
            
                <a href="ecgd.html">
            
                    
                    Early career, gender and diversity
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.21" data-path="contributing-lesson.html">
            
                <a href="contributing-lesson.html">
            
                    
                    Contribute to this lesson
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../second-analysis-steps/">
            
                <a href="../second-analysis-steps/">
            
                    
                    Second analysis steps
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.1" data-path="../second-analysis-steps/lb-git.html">
            
                <a href="../second-analysis-steps/lb-git.html">
            
                    
                    Using git to develop LHCb software
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.2" data-path="../second-analysis-steps/building-decays.html">
            
                <a href="../second-analysis-steps/building-decays.html">
            
                    
                    Building your own decay
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.2.1" data-path="../second-analysis-steps/building-decays-part0.html">
            
                <a href="../second-analysis-steps/building-decays-part0.html">
            
                    
                    The Selection Framework
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.2.2" data-path="../second-analysis-steps/building-decays-part1.html">
            
                <a href="../second-analysis-steps/building-decays-part1.html">
            
                    
                    A Historical Approach
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.2.3" data-path="../second-analysis-steps/building-decays-part2.html">
            
                <a href="../second-analysis-steps/building-decays-part2.html">
            
                    
                    Modern Selection Framework
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.3" data-path="../second-analysis-steps/fixing-errors.html">
            
                <a href="../second-analysis-steps/fixing-errors.html">
            
                    
                    What to do when something fails
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4" data-path="../second-analysis-steps/rerun-stripping.html">
            
                <a href="../second-analysis-steps/rerun-stripping.html">
            
                    
                    Run a different stripping line on simulated data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.5" data-path="../second-analysis-steps/switch-mass-hypo.html">
            
                <a href="../second-analysis-steps/switch-mass-hypo.html">
            
                    
                    Replace a mass hypothesis
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6" data-path="../second-analysis-steps/filter-in-trees.html">
            
                <a href="../second-analysis-steps/filter-in-trees.html">
            
                    
                    Reuse particles from a decay tree
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.7" data-path="../second-analysis-steps/simulation.html">
            
                <a href="../second-analysis-steps/simulation.html">
            
                    
                    The simulation framework
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.7.1" data-path="../second-analysis-steps/simulation-intro.html">
            
                <a href="../second-analysis-steps/simulation-intro.html">
            
                    
                    Introduction: The basics of Gauss
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.7.2" data-path="../second-analysis-steps/simulation-running-gauss.html">
            
                <a href="../second-analysis-steps/simulation-running-gauss.html">
            
                    
                    Getting the correct option files
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.7.3" data-path="../second-analysis-steps/simulation-dkfiles.html">
            
                <a href="../second-analysis-steps/simulation-dkfiles.html">
            
                    
                    Controlling the decay
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.7.4" data-path="../second-analysis-steps/simulation-advanced-dkfiles.html">
            
                <a href="../second-analysis-steps/simulation-advanced-dkfiles.html">
            
                    
                    Advanced: Controlling the decay
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.7.5" data-path="../second-analysis-steps/simulation-gencuts.html">
            
                <a href="../second-analysis-steps/simulation-gencuts.html">
            
                    
                    Modifying generator cuts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.7.6" data-path="../second-analysis-steps/simulation-fastsim.html">
            
                <a href="../second-analysis-steps/simulation-fastsim.html">
            
                    
                    Fast simulation options
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.8" data-path="../second-analysis-steps/hlt-intro.html">
            
                <a href="../second-analysis-steps/hlt-intro.html">
            
                    
                    HLT intro
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.9" data-path="../second-analysis-steps/tistos-diy.html">
            
                <a href="../second-analysis-steps/tistos-diy.html">
            
                    
                    TisTos DIY
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.10" data-path="../second-analysis-steps/ganga-scripting.html">
            
                <a href="../second-analysis-steps/ganga-scripting.html">
            
                    
                    Ganga Scripting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.11" data-path="../second-analysis-steps/managing-files-with-ganga.html">
            
                <a href="../second-analysis-steps/managing-files-with-ganga.html">
            
                    
                    Managing files in Ganga
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.12" data-path="../second-analysis-steps/analysis-automation-snakemake.html">
            
                <a href="../second-analysis-steps/analysis-automation-snakemake.html">
            
                    
                    Analysis automation: snakemake
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="../self-guided-lessons/">
            
                <a href="../self-guided-lessons/">
            
                    
                    Self guided lessons
            
                </a>
            

            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="5.1" >
            
                <a target="_blank" href="ref://starterkit-lessons.pdf">
            
                    
                    Download PDF
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Running a minimal DaVinci job locally</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="running-a-minimal-davinci-job-locally">Running a minimal DaVinci job locally</h1>
<p><a href="interactive-dst.html">Looping event-by-event</a> over a file and <a href="loki-functors.html">inspecting
interesting quantities with LoKi functors</a> is great for
exploration: to checking that the file contains the candidates you need, that
the topology makes sense, and so on.
It&apos;s impractical for most cases, though, where you want <em>all</em> the candidates
your trigger/stripping line produced, which could be tens of millions of
decays.
In these cases we use DaVinci, the application for analysing high-level
information such as tracks and vertices, which we&apos;ll look at in this lesson to
produce a ROOT ntuple.</p>
<p><div class="panel panel-warning"><div class="panel-heading"><h3 class="panel-title" onclick="javascript:toggle(3816262852);" id="learning-objectives"><i class="fa fa-line-chart"></i> Learning Objectives<span id="heading-3816262852"></span></h3></div><div class="panel-body" id="panel-3816262852"><ul>
<li>Run a DaVinci job over a local DST</li>
<li>Inspect the ntuple output</li>
<li>Set up the job to run in Ganga</li>
</ul>
</div></div> </p>
<p>With some stripped data located, it&apos;s useful to store the information on the
selected particles inside an ntuple.
This allows for quick, local analysis with <a href="https://root.cern.ch/" target="_blank">ROOT</a>,
rather than always searching through a DST that contains lots of things we&apos;re
not interested in.</p>
<p>As well as being the application that runs the stripping,
<a href="http://lhcbdoc.web.cern.ch/lhcbdoc/davinci/" target="_blank">DaVinci</a>
allows you to access events stored in DSTs and copy the information to ROOT
ntuples.
You tell DaVinci what you want it to do through <em>options files</em>, written in
Python.
There are lots of things you can do with DaVinci options files, as there&apos;s lots
of information available on the DST, but for now we&apos;ll just work on getting the
bare essentials up and running.</p>
<p>Our main tool will be the <code>DecayTreeTuple</code> object, which we&apos;ll create inside a
file we will call <code>ntuple_options.py</code>:</p>
<pre><code class="lang-python"><span class="hljs-keyword">from</span> Configurables <span class="hljs-keyword">import</span> DecayTreeTuple
<span class="hljs-keyword">from</span> DecayTreeTuple.Configuration <span class="hljs-keyword">import</span> *

<span class="hljs-comment"># Stream and stripping line we want to use</span>
stream = <span class="hljs-string">&apos;AllStreams&apos;</span>
line = <span class="hljs-string">&apos;D2hhPromptDst2D2KKLine&apos;</span>

<span class="hljs-comment"># Create an ntuple to capture D*+ decays from the StrippingLine line</span>
dtt = DecayTreeTuple(<span class="hljs-string">&apos;TupleDstToD0pi_D0ToKK&apos;</span>)
dtt.Inputs = [<span class="hljs-string">&apos;/Event/{0}/Phys/{1}/Particles&apos;</span>.format(stream, line)]
dtt.Decay = <span class="hljs-string">&apos;[D*(2010)+ -&gt; (D0 -&gt; K- K+) pi+]CC&apos;</span>
</code></pre>
<p>This imports the <code>DecayTreeTuple</code> class, and then creates an object called
<code>dtt</code> representing our ntuple.
Once DaVinci has run, the resulting ntuple will be saved in a folder within the
output ROOT file called <code>TupleDstToD0pi_D0ToKpi</code>.</p>
<p>The <code>Inputs</code> attribute specifies where <code>DecayTreeTuple</code> should look for
particles, and here we want it to look at the output of the stripping line
we&apos;re interested in.</p>
<p>As stripping lines can save many decays to a DST, the <code>Decay</code> attribute
specifies what decay we would like to have in our ntuple.
If there are no particles at the <code>Input</code> location, or the <code>Decay</code> string
doesn&apos;t match any particles at that location, the ntuple will not be filled.</p>
<p><div class="panel panel-primary"><div class="panel-heading"><h3 class="panel-title" onclick="javascript:toggle(4925906762);" id="decay-descriptors"><i class="fa fa-info-circle"></i> Decay descriptors<span id="heading-4925906762"></span></h3></div><div class="panel-body" id="panel-4925906762"><p>There is a special syntax for the <code>Decay</code> attribute string, commonly called
&apos;decay descriptors&apos;, that allow a lot of flexibility with what you accept.
For example, <code>D0 -&gt; K- X+</code> will match any D0 decay that contains one
negatively charged kaon and one positively charged track of any species.
More information the decay descriptor syntax can be found on the <a href="https://twiki.cern.ch/twiki/bin/view/LHCb/FAQ/LoKiNewDecayFinders" target="_blank">LoKi decay
finders TWiki
page</a>.</p>
</div></div> </p>
<p>Now we need to tell DaVinci how to behave.
The <code>DaVinci</code> class allows you to tell DaVinci how many events to run over,
what type of data is being used, what algorithms to run over the events, and so
on.</p>
<p>There are <a href="http://lhcb-doxygen.web.cern.ch/lhcb-doxygen/davinci/latest/py/dc/d2f/class_da_vinci_1_1_configuration_1_1_da_vinci.html" target="_blank">many configuration
attributes</a>
defined on the <code>DaVinci</code> object, but we will only set the ones that are
necessary for us.</p>
<pre><code class="lang-python"><span class="hljs-keyword">from</span> Configurables <span class="hljs-keyword">import</span> DaVinci

<span class="hljs-comment"># Configure DaVinci</span>
DaVinci().UserAlgorithms += [dtt]
DaVinci().InputType = <span class="hljs-string">&apos;DST&apos;</span>
DaVinci().TupleFile = <span class="hljs-string">&apos;DVntuple.root&apos;</span>
DaVinci().PrintFreq = <span class="hljs-number">1000</span>
DaVinci().DataType = <span class="hljs-string">&apos;2016&apos;</span>
DaVinci().Simulation = <span class="hljs-keyword">True</span>
<span class="hljs-comment"># Only ask for luminosity information when not using simulated data</span>
DaVinci().Lumi = <span class="hljs-keyword">not</span> DaVinci().Simulation
DaVinci().EvtMax = <span class="hljs-number">-1</span>
DaVinci().CondDBtag = <span class="hljs-string">&apos;sim-20161124-2-vc-md100&apos;</span>
DaVinci().DDDBtag = <span class="hljs-string">&apos;dddb-20150724&apos;</span>
</code></pre>
<p>Nicely, a lot of the attributes of the <code>DaVinci</code> object are self-explanatory:
<code>InputType</code> should be <code>&apos;DST&apos;</code> when giving DaVinci DST files; <code>PrintFreq</code>
defines how often DaVinci should print its status; <code>DataType</code> is the year of
data-taking the data corresponds to, which we get from looking at the
bookkeeping path used to get the input DST; <code>Simulation</code> should be <code>True</code> when
using Monte Carlo data, <code>Lumi</code> defines whether to store information on the
integrated luminosity the input data corresponds to; and <code>EvtMax</code> defines how
many events to run over, where a value of <code>-1</code> means &quot;all events&quot;.</p>
<p>The <code>CondDBtag</code> and <code>DDDBtag</code> attributes specify the exact detector conditions
that the Monte Carlo was generated with.
Specifying these tags is important, as without them you can end up with the
wrong magnet polarity value in your ntuple, amongst other Bad Things.
You can find the values for these tags in the <a href="data/MC_2016_27163002_Beam6500GeV2016MagDownNu1.625nsPythia8_Sim09b_Trig0x6138160F_Reco16_Turbo03_Stripping28NoPrescalingFlagged_ALLSTREAMS.DST.py">bookkeeping
file</a>
we downloaded earlier.</p>
<p><div class="panel panel-primary"><div class="panel-heading"><h3 class="panel-title" onclick="javascript:toggle(7430609870);" id="database-tags"><i class="fa fa-info-circle"></i> Database tags<span id="heading-7430609870"></span></h3></div><div class="panel-body" id="panel-7430609870"><p>Generally, the <code>CondDB</code> and <code>DDDB</code> tags are different for each dataset you
want to use, but will be the same for all DSTs within a given dataset.</p>
<p>For real collision data, you shouldn&apos;t specify these tags, as the default
tags are the latest and greatest, so just remove those lines from the options
file.</p>
<p>However, when using simulated data, <em>always</em> find out what the database tags are for
your dataset!</p>
<p>There are several ways to access the database tags used for a specific production, but the most reliable one consists of the following steps:</p>
<ul>
<li>Find the bookkeeping location of any DST for your desired event type and conditions (e.g. <code>/lhcb/MC/2016/ALLSTREAMS.DST/00070793/0000/00070793_00000002_7.AllStreams.dst</code>).</li>
<li>The number after <code>ALLSTREAMS.DST</code> is the number of the production: in this case, <code>00070793</code>.</li>
<li>Go to the <a href="https://lhcb-portal-dirac.cern.ch/DIRAC/?view=tabs&amp;theme=Grey&amp;url_state=1|*LHCbDIRAC.BookkeepingBrowser.classes.BookkeepingBrowser:*LHCbDIRAC.LHCbTransformationMonitor.classes.LHCbTransformationMonitor:," target="_blank">transformation monitor</a>. Put this number in the field <code>ProductionID(s):</code> and press &quot;Submit&quot;. You will see the details of the production to the right.</li>
<li>Click the right button on these details, and press &quot;Show request&quot;. The new tab &quot;Production Request manager&quot; will appear to the right of the &quot;LHCb Transformation Monitor&quot;. Go to that tab.</li>
<li>You will see the details of the MC request. Click right button on it, and press &quot;View&quot;.</li>
<li>A new window will pop up with the complete details of the request. You have to find the &quot;Step 1&quot; section, and the following line in it <code>DDDB: dddb-20170721-3 Condition DB: sim-20170721-2-vc-md100</code> contains your database tags.</li>
</ul>
<p>Note that the Condition DB tags for different magnet polarities are different: <code>-md100</code> should be replaced by <code>-mu100</code> for the MagUp conditions. </p>
<p>This method can also be used to find other details about how any data was processed by DIRAC, such as the options files and application versions.</p>
</div></div> </p>
<p>In order to run an algorithm that we have previously created, we need to add it
to the <code>UserAlgorithms</code> list.
The <code>TupleFile</code> attribute defines the name of the ROOT output file that DaVinci
will store any algorithm output in, which should be our ntuple.</p>
<p><div class="panel panel-primary"><div class="panel-heading"><h3 class="panel-title" onclick="javascript:toggle(5137393730);" id="being-smart-and-efficient"><i class="fa fa-info-circle"></i> Being smart and efficient<span id="heading-5137393730"></span></h3></div><div class="panel-body" id="panel-5137393730"><p>Typical stripping lines take only a small part of the stripped stream - so, a small fraction of events in the DST: actually, usually you care about a single TES location!
At the same time, event unpacking and running the DecayTreeTuple machinery for each event is time-consuming. 
Consequently, DSTs can be processed much faster if before unpacking we select <em>only</em> events which are likely to accomodate the desired TES location. This can be achieved, for example, by requiring a prefilter checking whether event passes a stripping requirement. You may also filter on trigger decisions - this is an idea behind the Turbo stream.
As a conclusion, it is <em>strongly</em> recommended to exploit the <code>EventPreFilters</code> method offered by <code>DaVinci</code>: this feature can save a lot of processing time and collaboration&apos;s computing resources when running over millions of events.
To require events to pass a specific stripping line requirement, one should add these lines to the options file:</p>
<pre><code class="lang-python"><span class="hljs-keyword">from</span> PhysConf.Filters <span class="hljs-keyword">import</span> LoKi_Filters
fltrs = LoKi_Filters (
    STRIP_Code = <span class="hljs-string">&quot;HLT_PASS_RE(&apos;StrippingD2hhPromptDst2D2KKLineDecision&apos;)&quot;</span>
)
DaVinci().EventPreFilters = fltrs.filters(<span class="hljs-string">&apos;Filters&apos;</span>)
</code></pre>
<p>Here we use the <a href="http://lhcb-doxygen.web.cern.ch/lhcb-doxygen/davinci/latest/d7/dae/namespace_lo_ki_1_1_cuts.html#aee4bba9ae8443acd970dd52e20e5b8c1" target="_blank">LoKi functor <code>HLT_PASS_RE</code></a> which checks for a positive decision on (in this case) the stripping line. 
You may investigate some of more advanced examples of <code>EventPreFilters</code> usage <a href="https://twiki.cern.ch/twiki/bin/view/LHCb/FAQ/DaVinciFAQ#How_to_process_the_stripped_DSTs" target="_blank">here</a> and <a href="https://gitlab.cern.ch/lhcb/Phys/blob/master/Phys/PhysConf/python/PhysConf/Filters.py" target="_blank">here</a>.</p>
</div></div> </p>
<p>All that&apos;s left to do is to say what data we would like to run over.
As we already have a data file <a href="files-from-grid.html">downloaded locally</a>, we
define that as our input data.</p>
<pre><code class="lang-python"><span class="hljs-keyword">from</span> GaudiConf <span class="hljs-keyword">import</span> IOHelper

<span class="hljs-comment"># Use the local input data</span>
IOHelper().inputFiles([
    <span class="hljs-string">&apos;./00070793_00000001_7.AllStreams.dst&apos;</span>
], clear=<span class="hljs-keyword">True</span>)
</code></pre>
<p>This says to use the <code>.dst</code> file that is in the same directory as the options
file, and to clear any previous input files that might have been defined.</p>
<p>That&apos;s it! We&apos;re ready to run DaVinci.</p>
<p>In the same folder as your options file <code>ntuple_options.py</code> and your DST file
ending in <code>.dst</code>, there&apos;s just a single command you need run on <code>lxplus</code>.</p>
<pre><code class="lang-shell">$ lb-run DaVinci/v44r6 gaudirun.py ntuple_options.py
</code></pre>
<p>The full options file we&apos;ve created, <code>ntuple_options.py</code>, is <a href="code/minimal-dv/ntuple_options.py">available
here</a>.
A slightly modified version that uses remote files (using an XML catalog as
<a href="files-from-grid.html">described here</a>) is <a href="code/minimal-dv/ntuple_options_xmlcatalog.py">available
here</a>.</p>
<p><div class="panel panel-primary"><div class="panel-heading"><h3 class="panel-title" onclick="javascript:toggle(3434786120);" id="using-a-microdst"><i class="fa fa-info-circle"></i> Using a microDST<span id="heading-3434786120"></span></h3></div><div class="panel-body" id="panel-3434786120"><p>A microDST (or &#xB5;DST) is a smaller version of a DST.
Some stripping lines go to &#xB5;DSTs, and some go to DSTs.
There are two things that need changing in our options file in order to have
it work when it is used with a stripping line that goes to a &#xB5;DST:</p>
<ol>
<li>The <code>DecayTreeTuple.Inputs</code> attribute should start at the word
<code>Phys</code>; and</li>
<li>The <code>RootInTES</code> attribute on the <code>DaVinci</code> object has to be set to
<code>/Event/$STREAM</code></li>
</ol>
<p>In context, the changes look like</p>
<pre><code class="lang-python">dtt.Inputs = [<span class="hljs-string">&apos;Phys/{0}/Particles&apos;</span>.format(line)]
<span class="hljs-comment"># ...</span>
DaVinci().RootInTES = <span class="hljs-string">&apos;/Event/{0}&apos;</span>.format(stream)
</code></pre>
</div></div> </p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="interactive-dst.html" class="navigation navigation-prev " aria-label="Previous page: Interactively exploring a DST">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="loki-functors.html" class="navigation navigation-next " aria-label="Next page: Fun with LoKi Functors">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Running a minimal DaVinci job locally","level":"2.1.10","depth":2,"next":{"title":"Fun with LoKi Functors","level":"2.1.11","depth":2,"path":"first-analysis-steps/loki-functors.md","ref":"first-analysis-steps/loki-functors.md","articles":[]},"previous":{"title":"Interactively exploring a DST","level":"2.1.9","depth":2,"path":"first-analysis-steps/interactive-dst.md","ref":"first-analysis-steps/interactive-dst.md","articles":[]},"dir":"ltr"},"config":{"plugins":["-sharing","panels@git+https://github.com/lhcb/gitbook-plugin-panels.git#master","katex-auto-render@git+https://github.com/lhcb/gitbook-plugin-katex-auto-render.git#master","collapsible-menu","otherlink"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"collapsible-menu":{},"search":{},"otherlink":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"panels":{},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"katex-auto-render":{},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","author":"The Starterkit team and contributors","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"gitbook":"*"},"file":{"path":"first-analysis-steps/minimal-dv-job.md","mtime":"2018-11-24T18:44:17.466Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2018-11-24T18:45:53.176Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-panels/panels.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-katex-auto-render/katex.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-katex-auto-render/auto-render.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-katex-auto-render/enable-auto-render.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-collapsible-menu/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-otherlink/js/otherlink.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

