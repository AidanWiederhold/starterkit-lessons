
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Fun with LoKi Functors Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="The Starterkit team and contributors">
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-panels/panels.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-katex-auto-render/katex.min.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="minimal-dv-job.html" />
    
    
    <link rel="prev" href="interactive-dst.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    The LHCb Starterkit
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.1" data-path="../CONTRIBUTING.html">
            
                <a href="../CONTRIBUTING.html">
            
                    
                    Contributing
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="./">
            
                <a href="./">
            
                    
                    First analysis steps
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.1" data-path="prerequisites.html">
            
                <a href="prerequisites.html">
            
                    
                    Pre-workshop checklist
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.2" data-path="introduction-to-course.html">
            
                <a href="introduction-to-course.html">
            
                    
                    Goals of the course
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.3" data-path="dataflow.html">
            
                <a href="dataflow.html">
            
                    
                    The LHCb data flow
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.4" data-path="run-2-data-flow.html">
            
                <a href="run-2-data-flow.html">
            
                    
                    Changes to the data flow in Run 2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.5" data-path="davinci.html">
            
                <a href="davinci.html">
            
                    
                    An introduction to LHCb Software
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.6" data-path="bookkeeping.html">
            
                <a href="bookkeeping.html">
            
                    
                    Finding data in the Bookkeeping
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.7" data-path="files-from-grid.html">
            
                <a href="files-from-grid.html">
            
                    
                    Downloading a file from the grid
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.8" data-path="interactive-dst.html">
            
                <a href="interactive-dst.html">
            
                    
                    Interactively exploring a DST
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="2.1.9" data-path="loki-functors.html">
            
                <a href="loki-functors.html">
            
                    
                    Fun with LoKi Functors
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.10" data-path="minimal-dv-job.html">
            
                <a href="minimal-dv-job.html">
            
                    
                    Running a minimal DaVinci job locally
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.11" data-path="davinci-grid.html">
            
                <a href="davinci-grid.html">
            
                    
                    Running DaVinci on the grid
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.12" data-path="add-tupletools.html">
            
                <a href="add-tupletools.html">
            
                    
                    TupleTools and branches
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.13" data-path="decay-tree-fitter.html">
            
                <a href="decay-tree-fitter.html">
            
                    
                    How do I use DecayTreeFitter?
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.14" data-path="ganga-data.html">
            
                <a href="ganga-data.html">
            
                    
                    More Ganga
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.15" data-path="eos-storage.html">
            
                <a href="eos-storage.html">
            
                    
                    Storing large files on EOS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.16" data-path="split-jobs.html">
            
                <a href="split-jobs.html">
            
                    
                    Splitting a job into subjobs
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.17" data-path="lhcb-dev.html">
            
                <a href="lhcb-dev.html">
            
                    
                    Developing LHCb Software
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.18" data-path="asking-questions.html">
            
                <a href="asking-questions.html">
            
                    
                    Asking good questions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.19" data-path="ecgd.html">
            
                <a href="ecgd.html">
            
                    
                    Early career, gender and diversity
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.20" data-path="contributing-lesson.html">
            
                <a href="contributing-lesson.html">
            
                    
                    Contribute to this lesson
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../second-analysis-steps/">
            
                <a href="../second-analysis-steps/">
            
                    
                    Second analysis steps
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.1" data-path="../second-analysis-steps/lb-git.html">
            
                <a href="../second-analysis-steps/lb-git.html">
            
                    
                    Using git to develop LHCb software
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.2" data-path="../second-analysis-steps/building-decays.html">
            
                <a href="../second-analysis-steps/building-decays.html">
            
                    
                    Building your own decay
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.2.1" data-path="../second-analysis-steps/building-decays-part0.html">
            
                <a href="../second-analysis-steps/building-decays-part0.html">
            
                    
                    The Selection Framework
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.2.2" data-path="../second-analysis-steps/building-decays-part1.html">
            
                <a href="../second-analysis-steps/building-decays-part1.html">
            
                    
                    A Historical Approach
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.2.3" data-path="../second-analysis-steps/building-decays-part2.html">
            
                <a href="../second-analysis-steps/building-decays-part2.html">
            
                    
                    Modern Selection Framework
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.3" data-path="../second-analysis-steps/fixing-errors.html">
            
                <a href="../second-analysis-steps/fixing-errors.html">
            
                    
                    What to do when something fails
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4" data-path="../second-analysis-steps/rerun-stripping.html">
            
                <a href="../second-analysis-steps/rerun-stripping.html">
            
                    
                    Run a different stripping line on simulated data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.5" data-path="../second-analysis-steps/switch-mass-hypo.html">
            
                <a href="../second-analysis-steps/switch-mass-hypo.html">
            
                    
                    Replace a mass hypothesis
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6" data-path="../second-analysis-steps/filter-in-trees.html">
            
                <a href="../second-analysis-steps/filter-in-trees.html">
            
                    
                    Reuse particles from a decay tree
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.7" data-path="../second-analysis-steps/simulation.html">
            
                <a href="../second-analysis-steps/simulation.html">
            
                    
                    The simulation framework
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.7.1" data-path="../second-analysis-steps/simulation-intro.html">
            
                <a href="../second-analysis-steps/simulation-intro.html">
            
                    
                    Introduction: The basics of Gauss
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.7.2" data-path="../second-analysis-steps/simulation-running-gauss.html">
            
                <a href="../second-analysis-steps/simulation-running-gauss.html">
            
                    
                    Getting the correct option files
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.7.3" data-path="../second-analysis-steps/simulation-dkfiles.html">
            
                <a href="../second-analysis-steps/simulation-dkfiles.html">
            
                    
                    Controlling the decay
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.7.4" data-path="../second-analysis-steps/simulation-advanced-dkfiles.html">
            
                <a href="../second-analysis-steps/simulation-advanced-dkfiles.html">
            
                    
                    Advanced: Controlling the decay
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.7.5" data-path="../second-analysis-steps/simulation-gencuts.html">
            
                <a href="../second-analysis-steps/simulation-gencuts.html">
            
                    
                    Modifying generator cuts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.7.6" data-path="../second-analysis-steps/simulation-fastsim.html">
            
                <a href="../second-analysis-steps/simulation-fastsim.html">
            
                    
                    Fast simulation options
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.8" data-path="../second-analysis-steps/hlt-intro.html">
            
                <a href="../second-analysis-steps/hlt-intro.html">
            
                    
                    HLT intro
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.9" data-path="../second-analysis-steps/tistos-diy.html">
            
                <a href="../second-analysis-steps/tistos-diy.html">
            
                    
                    TisTos DIY
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.10" data-path="../second-analysis-steps/ganga-scripting.html">
            
                <a href="../second-analysis-steps/ganga-scripting.html">
            
                    
                    Ganga Scripting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.11" data-path="../second-analysis-steps/managing-files-with-ganga.html">
            
                <a href="../second-analysis-steps/managing-files-with-ganga.html">
            
                    
                    Managing files in Ganga
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.12" data-path="../second-analysis-steps/analysis-automation-snakemake.html">
            
                <a href="../second-analysis-steps/analysis-automation-snakemake.html">
            
                    
                    Analysis automation: snakemake
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="4.1" >
            
                <a target="_blank" href="ref://starterkit-lessons.pdf">
            
                    
                    Download PDF
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Fun with LoKi Functors</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="fun-with-loki-functors">Fun with LoKi Functors</h1>
<p><div class="panel panel-warning"><div class="panel-heading"><h3 class="panel-title" onclick="javascript:toggle(7214518065);" id="learning-objectives"><i class="fa fa-line-chart"></i> Learning Objectives<span id="heading-7214518065"></span></h3></div><div class="panel-body" id="panel-7214518065"><ul>
<li>Find out how the physics information can be obtained from the DST</li>
<li>Understand what LoKi functors are</li>
<li>Use LoKi functors interactively</li>
<li>Be able to find functors that do what we want</li>
</ul>
</div></div> </p>
<p>LoKi functors are designed to flexibly compute and compare properties of the 
current decay, from simple quantities such as the transverse momentum of a 
particle to complicated ones like helicity angles.
Internally, functors are implemented as C++ classes that take an object of type <code>TYPE1</code> and return another of <code>TYPE2</code>.
They can be used both in C++ and in Python code, and can be combined with each other using logical operations.</p>
<p>According to <code>TYPE2</code> there are 3 types of functors:</p>
<ul>
<li><em>Functions</em>, which return <code>double</code>.</li>
<li><em>Predicates</em>, which return a <code>bool</code>.</li>
<li><em>Streamers</em>, which return a <code>std::vector</code> of some other type <code>TYPE3</code>.</li>
</ul>
<p>When filling tuples, the most used functors are functions, while predicates are typically used for selections.</p>
<p>According to <code>TYPE1</code>, there are many types of functors, the most important of which are (you can find a full list in the <a href="https://twiki.cern.ch/twiki/bin/view/LHCb/FAQ/LoKiFAQ#How_to_code_own_LoKi_functor" target="_blank">LoKi FAQ</a>):</p>
<ul>
<li><em>Particle functors</em>, which take <code>LHCb::Particle*</code> as input.</li>
<li><em>Vertex functors</em>, which take <code>LHCb::VertexBase*</code> as input.</li>
<li><em>MC particle functors</em>, which take <code>LHCb::MCParticle*</code> as input.</li>
<li><em>MC vertex functors</em>, which take <code>LHCb::MCVertex*</code> as input.</li>
<li><em>Array particle functors</em>, which take a <code>LoKi::Range_</code> (an array of particles) as input.</li>
<li><em>Track functors</em>, which take <code>LHCb::Track</code> as input.</li>
</ul>
<p><div class="panel panel-primary"><div class="panel-heading"><h3 class="panel-title" onclick="javascript:toggle(965139109);" id="c-classes"><i class="fa fa-info-circle"></i> C++ classes<span id="heading-965139109"></span></h3></div><div class="panel-body" id="panel-965139109"><p>Things like <code>LHCb::Particle</code> are C++ classes that usually represent some 
physical object. You will interact with the C++ objects directly very rarely, 
if ever.</p>
</div></div> </p>
<p>To understand what we can do with LoKi functors, we will pick up from where we 
left off <a href="interactive-dst.html">exploring a DST interactively</a>.
Open the DST and get the first candidate in the <code>D2hhPromptDst2D2KKLine</code> line:</p>
<pre><code class="lang-python">cands = evt[<span class="hljs-string">&apos;/Event/AllStreams/Phys/D2hhPromptDst2D2KKLine/Particles&apos;</span>]
cand = cands[<span class="hljs-number">0</span>]
</code></pre>
<p>We can now try to get very simple properties of the $$D^{* -}$$ candidate. Let&apos;s start from the components of its momentum.
This can be done calling the function <code>momentum()</code> for our candidate in the following way:</p>
<pre><code class="lang-python">p_x = cand.momentum().X()
p_y = cand.momentum().Y()
p_z = cand.momentum().Z()
<span class="hljs-keyword">print</span> p_x, p_y, p_z
</code></pre>
<p>This is inconvenient when <a href="minimal-dv-job.html">running DaVinci with Python options files</a>: there&apos;s no way of calling the <code>momentum()</code> method.
Instead, we can use the corresponding LoKi particle functors:</p>
<pre><code class="lang-python"><span class="hljs-keyword">from</span> LoKiPhys.decorators <span class="hljs-keyword">import</span> PX, PY, PZ
<span class="hljs-keyword">print</span> PX(cand)
<span class="hljs-keyword">print</span> PY(cand)
<span class="hljs-keyword">print</span> PZ(cand)
</code></pre>
<p>You will see an error when loading the functors:</p>
<pre><code>LoKiSvc.REPORT      ERROR LoKi::AuxDesktopBase:     loadDesktop(): unable to load IPhysDesktop! StatusCode=FAILURE
LoKiSvc.REPORT      ERROR The   ERROR message is suppressed : &apos;LoKi::AuxDesktopBase:     loadDesktop(): unable to load IPhysDesktop!&apos; StatusCode=FAILURE
</code></pre><p>This is related to the fact that some functors need to run in the <code>DaVinci</code> 
&#x2018;scope&#x2019;, and they are all loaded in the <code>LoKiPhys.decorators</code> module. It&apos;s 
harmless in the examples we will use.
If the import is made <em>before</em> the instantiation of the <code>ApplicationMgr</code>, there 
will be no warnings.</p>
<p><div class="panel panel-success"><div class="panel-heading"><h3 class="panel-title" onclick="javascript:toggle(7363625263);" id="does-it-make-sense"><i class="fa fa-square-o"></i> Does it make sense?<span id="heading-7363625263"></span></h3></div><div class="panel-body" id="panel-7363625263"><p>Compare the output of <code>PX</code> functor with the result of calling the function <code>cand.momentum().X()</code>. </p>
</div></div> </p>
<p>Math operations are also allowed:</p>
<pre><code class="lang-python">p_components_sum = PX + PY + PZ
p_components_sum(cand)
</code></pre>
<p>There exist specific LoKi functors for all the most important properties of the particle. For example, the transverse momentum and mass:</p>
<pre><code class="lang-python"><span class="hljs-keyword">from</span> LoKiPhys.decorators <span class="hljs-keyword">import</span> PT, M
<span class="hljs-keyword">print</span> PT(cand)
<span class="hljs-keyword">print</span> M(cand)
</code></pre>
<p><div class="panel panel-success"><div class="panel-heading"><h3 class="panel-title" onclick="javascript:toggle(4606459644);" id="some-practice"><i class="fa fa-square-o"></i> Some practice<span id="heading-4606459644"></span></h3></div><div class="panel-body" id="panel-4606459644"><p>Retrieve the momentum magnitude using functors <code>PX</code>, <code>PY</code> and <code>PZ</code>. There is also a specific functor <code>P</code> which does the job. Compare the results. </p>
<p>Now, retrieve the transverse momentum and invariant mass (you will probably need the energy functor <code>E</code>), and see if it matches what the <code>PT</code> and <code>M</code> functors return.</p>
</div></div> </p>
<p><div class="panel panel-primary"><div class="panel-heading"><h3 class="panel-title" onclick="javascript:toggle(4638009956);" id="a-note-about-units"><i class="fa fa-info-circle"></i> A note about units<span id="heading-4638009956"></span></h3></div><div class="panel-body" id="panel-4638009956"><p>By the <a href="http://lhcb-comp.web.cern.ch/lhcb-comp/Support/Conventions/units.pdf" target="_blank">convention</a>, the LHCb default units are MeV, millimeters and nanoseconds. It is easy to print the values of interest in other units:</p>
<pre><code class="lang-python"><span class="hljs-keyword">from</span> LoKiPhys.decorators <span class="hljs-keyword">import</span> GeV
<span class="hljs-keyword">print</span> PT(cand)/GeV
</code></pre>
</div></div> </p>
<p>If we want to get the properties of the $$D^{* -}$$ vertex, for example its fit 
quality ($$\chi^2$$), we need to pass a vertex object to the vertex functor.</p>
<pre><code class="lang-python"><span class="hljs-keyword">from</span> LoKiPhys.decorators <span class="hljs-keyword">import</span> VCHI2
<span class="hljs-keyword">print</span> VCHI2(cand.endVertex())
</code></pre>
<p>Again, this is inconvenient when <a href="minimal-dv-job.html">running DaVinci with Python options 
files</a>, since in that case we don&apos;t have any way of 
calling the <code>endVertex</code> method.
Instead, we can use the <code>VFASPF</code> <em>adaptor</em> functor, which allows us to use 
vertex functors as if they were particle functors (note how the functor is 
built by combining two functors).</p>
<pre><code class="lang-python"><span class="hljs-keyword">from</span> LoKiPhys.decorators <span class="hljs-keyword">import</span> VFASPF
VCHI2(cand.endVertex()) == VFASPF(VCHI2)(cand)
</code></pre>
<p><div class="panel panel-success"><div class="panel-heading"><h3 class="panel-title" onclick="javascript:toggle(1562223629);" id="functions-of-functions-of-functions-of"><i class="fa fa-square-o"></i> Functions of functions of functions of&#x2026;<span id="heading-1562223629"></span></h3></div><div class="panel-body" id="panel-1562223629"><p>Make sure you understand what <code>VFASPF(VCHI2)(cand)</code> means. It may help to play 
around in Python, creating a function that takes another function as an 
argument, for example:</p>
<pre><code class="lang-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_greeting</span><span class="hljs-params">(salutation)</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">greet</span><span class="hljs-params">(name)</span>:</span>
        <span class="hljs-keyword">print</span> <span class="hljs-string">&apos;{0}, {1}!&apos;</span>.format(salutation, name)
    <span class="hljs-keyword">return</span> greet
</code></pre>
<p>What would <code>create_greeting(&apos;Hello&apos;)</code> return? What about 
<code>create_greeting(&apos;Howdy&apos;)(&apos;partner&apos;)</code>? Why is doing this useful?</p>
</div></div> </p>
<p>Calculation of some of the properties, such as the impact parameter (IP) or cosine of the 
direction angle (DIRA), requires the knowledge of the primary vertex (PV) 
associated to the candidate.
In <code>GaudiPython</code>, we can get the PVs ourselves.</p>
<pre><code class="lang-python">pv_finder_tool = appMgr.toolsvc().create(
    <span class="hljs-string">&apos;GenericParticle2PVRelator&lt;_p2PVWithIPChi2, OfflineDistanceCalculatorName&gt;/P2PVWithIPChi2&apos;</span>,
    interface=<span class="hljs-string">&apos;IRelatedPVFinder&apos;</span>
)
pvs = evt[<span class="hljs-string">&apos;/Event/Rec/Vertex/Primary&apos;</span>]
best_pv = pv_finder_tool.relatedPV(cand, pvs)
</code></pre>
<p>Now, we can get the cosine of the direction angle for the candidate given the primary vertex: </p>
<pre><code class="lang-python"><span class="hljs-keyword">from</span> LoKiPhys.decorators <span class="hljs-keyword">import</span> DIRA
<span class="hljs-keyword">print</span> DIRA(best_pv)(cand)
</code></pre>
<p>Given that this is a very common operation, we have the possibility of using, in the context of a <code>DaVinci</code> application (Stripping, for example), a special set of functors, starting with the <code>BPV</code> prefix (for Best PV), which will get the PV for us.
Some functors also end with the suffix <code>DV</code>, which means they can only be used in the <code>DaVinci</code> context.</p>
<p>To get the quality of impact parameter of the candidate, one needs as well to call a distance calculator:</p>
<pre><code class="lang-python"><span class="hljs-keyword">from</span> GaudiPython.Bindings <span class="hljs-keyword">import</span> AppMgr, gbl 
gaudi = AppMgr() 
distCal = gaudi.toolSvc().create(<span class="hljs-string">&quot;LoKi::DistanceCalculator&quot;</span>, interface=gbl.IDistanceCalculator) 
ipTool = gbl.LoKi.Vertices.ImpactParamTool(distCal)
</code></pre>
<p>Now, we evaluate the quality of impact parameter of the candidate, given the primary vertex, and using the provided calculator:</p>
<pre><code class="lang-python"><span class="hljs-keyword">from</span> LoKiPhys.decorators <span class="hljs-keyword">import</span> IPCHI2
<span class="hljs-keyword">print</span> IPCHI2(best_pv, ipTool)(cand)
</code></pre>
<p>In the context of <code>DaVinci</code> application, e.g. the Stripping, the things become much simplier since the calculator instances are loaded automatically, and the syntax for calling the <code>IPCHI2</code> functor becomes <code>IPCHI2(best_pv,geo())(cand)</code>, where <code>geo()</code> is the geometry calculator tool.</p>
<p><div class="panel panel-primary"><div class="panel-heading"><h3 class="panel-title" onclick="javascript:toggle(2568973825);" id="finding-loki-functors"><i class="fa fa-info-circle"></i> Finding LoKi functors<span id="heading-2568973825"></span></h3></div><div class="panel-body" id="panel-2568973825"><p>The full list of defined LoKi functors can be found in the <code>LoKi::Cuts</code> 
namespace in the 
<a href="http://lhcb-release-area.web.cern.ch/LHCb-release-area/DOC/davinci/latest_doxygen/d7/dae/namespace_lo_ki_1_1_cuts.html" target="_blank">doxygen</a>.
They are quite well documented with examples on how to use them.
The list can be overwhelming, so it&apos;s also worth checking a more curated selection of functors in the TWiki, <a href="https://twiki.cern.ch/twiki/bin/view/LHCb/LoKiHybridFilters" target="_blank">here</a> and <a href="https://twiki.cern.ch/twiki/bin/view/LHCb/LoKiParticleFunctions" target="_blank">here</a>.</p>
</div></div> </p>
<p>So far we&apos;ve only looked at the properties of the head of the decay (that is, 
the $$D^{* -}$$), but what if we want to get information about its daughters? As 
an example, let&apos;s get the largest transverse momentum of the final state 
particles.
A simple solution would be to navigate the tree and calculate the maximum 
$$p_{\text{T}}$$.</p>
<pre><code class="lang-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">find_tracks</span><span class="hljs-params">(particle)</span>:</span>
    tracks = []
    <span class="hljs-keyword">if</span> particle.isBasicParticle():
        proto = particle.proto()
        <span class="hljs-keyword">if</span> proto:
            track = proto.track()
            <span class="hljs-keyword">if</span> track:
                <span class="hljs-keyword">try</span>:
                    tracks.append(particle.data())
                <span class="hljs-keyword">except</span> AttributeError:
                    tracks.append(particle)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">for</span> child <span class="hljs-keyword">in</span> particle.daughters():
            tracks.extend(find_tracks(child))
    <span class="hljs-keyword">return</span> tracks

max_pt = max([PT(child) <span class="hljs-keyword">for</span> child <span class="hljs-keyword">in</span> find_tracks(cand)])
</code></pre>
<p><div class="panel panel-primary"><div class="panel-heading"><h3 class="panel-title" onclick="javascript:toggle(848107307);" id="a-note-about-the-tryexcept"><i class="fa fa-info-circle"></i> A note about the try/except<span id="heading-848107307"></span></h3></div><div class="panel-body" id="panel-848107307"><p>If you import LoKi before running this example, it magically removes the 
<code>.data()</code> function and allows the particle to be used directly. The code above 
is made general using the <code>try</code>/<code>except</code> block and will work in either case.</p>
</div></div> </p>
<p>However, LoKi offers functions for performing such operations, namely <code>MAXTREE</code> and <code>MINTREE</code>, which get as parameters the selection criteria, the functor to calculate and a default value.
In our example,</p>
<pre><code class="lang-python"><span class="hljs-keyword">from</span> LoKiPhys.decorators <span class="hljs-keyword">import</span> MAXTREE, ISBASIC, HASTRACK
MAXTREE(ISBASIC &amp; HASTRACK, PT, <span class="hljs-number">-1</span>)(cand) == max_pt
</code></pre>
<p>In this example, we have used two selection functors, <code>ISBASIC</code> and <code>HASTRACK</code>, which return true if the particle doesn&apos;t have children and is made up by a track, respectively.
We can see that they do the same thing as <code>particle.isBasicParticle()</code> and <code>particle.proto().track()</code> in a more compact way.</p>
<p><div class="panel panel-primary"><div class="panel-heading"><h3 class="panel-title" onclick="javascript:toggle(4746492657);" id="combining-loki-cuts"><i class="fa fa-info-circle"></i> Combining LoKi cuts<span id="heading-4746492657"></span></h3></div><div class="panel-body" id="panel-4746492657"><p>You might have noticed above we used the <code>&amp;</code> operator (&quot;bitwise AND&quot;) to 
combine the <code>ISBASIC</code> and <code>HASTRACK</code> cuts above.
This is because Python doesn&apos;t allow LoKi to override the behaviour of <code>and</code> and <code>or</code> (&quot;logical AND/OR&quot;), so if we use them
the Python interpreter tries to combine the two cuts straight away, before we have even passed in our candidate:</p>
<pre><code class="lang-python">In [<span class="hljs-number">1</span>]: ((M&gt;<span class="hljs-number">1200</span>) <span class="hljs-keyword">or</span> (PT &gt; <span class="hljs-number">500</span>))
Out[<span class="hljs-number">1</span>]:  (M&gt;<span class="hljs-number">1200</span>)
</code></pre>
<p>the result is that our <code>PT</code> cut vanishes!
If we use the <code>|</code> operator (&quot;bitwise OR&quot;) then LoKi correctly builds a functor representing the <code>OR</code> of our cuts:</p>
<pre><code class="lang-python">In [<span class="hljs-number">2</span>]: ((M&gt;<span class="hljs-number">1200</span>) | (PT &gt; <span class="hljs-number">500</span>))
Out[<span class="hljs-number">2</span>]:  ( (M&gt;<span class="hljs-number">1200</span>) || (PT&gt;<span class="hljs-number">500</span>) )
</code></pre>
<p>This is why you should <strong>always</strong> use <code>&amp;</code> and <code>|</code> when combining LoKi functors, and <strong>never</strong> use <code>and</code> and <code>or</code>.</p>
</div></div> </p>
<p>Similarly, the <code>SUMTREE</code> functor allows us to accumulate quantities for those children that pass a certain selection:</p>
<pre><code class="lang-python"><span class="hljs-keyword">from</span> LoKiPhys.decorators <span class="hljs-keyword">import</span> SUMTREE, ABSID
<span class="hljs-keyword">print</span> SUMTREE(<span class="hljs-number">321</span> == ABSID, PT)(cand)
<span class="hljs-keyword">print</span> SUMTREE(<span class="hljs-string">&apos;K+&apos;</span> == ABSID, PT)(cand)
</code></pre>
<p>In this case, we have summed the transverse momentum of the charged kaons in the tree.
Note the usage of the <code>ABSID</code> functor, which selects particles from the decay 
tree using either their <a href="http://pdg.lbl.gov/2015/mcdata/mc_particle_id_contents.html" target="_blank">PDG Monte Carlo 
ID</a> or their name.
If you would like to consider only the kaons of one specific charge in the selection requirement, consider the <code>ID</code> functor which does exactly the same thing, however has a sign which is positive for particles and negative for antiparticles. </p>
<p>Another very useful LoKi functor is <code>CHILD</code>, which allows us to access a 
property of a single child of the particle.
To specify which child we want, its order is used, so we need to know how the candidate was built.
For example, from</p>
<pre><code class="lang-output">In [10]: cand.daughtersVector()
Out[10]:

0 |-&gt;D~0                          M/PT/E/PX/PY/PZ: 1.8643/ 2.841 / 34.29/ 1.288/ 2.532/ 34.12 [GeV]  #  1 
                                     EndVertex  X/Y/Z: 1.042/0.2034/-112.2 [mm]  Chi2/nDoF 0.007451/1 #  1 
1    |-&gt;K-                        M/PT/E/PX/PY/PZ: 0.4937/ 2.2054/ 19.37/ 1.481/ 1.634/ 19.23 [GeV]  #  8 
1    |-&gt;K+                        M/PT/E/PX/PY/PZ: 0.4937/ 0.9181/ 14.92/-0.1928/0.8977/ 14.89 [GeV]  #  7 
0 |-&gt;pi-                          M/PT/E/PX/PY/PZ: 0.1396/ 0.1808/ 2.544/0.1047/0.1474/ 2.534 [GeV]  #  1
</code></pre>
<p>we know that <code>D~0</code> is the first child and <code>pi-</code> is the second.
Therefore, to access the mass of the $$D^{0}$$ we have 2 options:</p>
<pre><code class="lang-python"><span class="hljs-keyword">from</span> LoKiPhys.decorators <span class="hljs-keyword">import</span> CHILD
<span class="hljs-comment"># Option 1</span>
mass = M(cand.daughtersVector()[<span class="hljs-number">0</span>])
<span class="hljs-comment"># Option 2</span>
mass_child = CHILD(M, <span class="hljs-number">1</span>)(cand)
<span class="hljs-comment"># Do they agree?</span>
mass == mass_child
</code></pre>
<p><div class="panel panel-success"><div class="panel-heading"><h3 class="panel-title" onclick="javascript:toggle(5700804994);" id="child-vertex"><i class="fa fa-square-o"></i> Child vertex?<span id="heading-5700804994"></span></h3></div><div class="panel-body" id="panel-5700804994"><p>Evaluate the quality of the </p>
</div></div> </p>
<p>In the similar way, we may access properties of child of the child: for example, a kaon from the $$D^{0}$$ decay:</p>
<pre><code class="lang-python"><span class="hljs-keyword">from</span> LoKiPhys.decorators <span class="hljs-keyword">import</span> CHILD
mass_kaon = CHILD(CHILD(M, <span class="hljs-number">1</span>),<span class="hljs-number">1</span>)(cand)
</code></pre>
<p><div class="panel panel-success"><div class="panel-heading"><h3 class="panel-title" onclick="javascript:toggle(5777553945);" id="tracks-and-pid"><i class="fa fa-square-o"></i> Tracks and PID<span id="heading-5777553945"></span></h3></div><div class="panel-body" id="panel-5777553945"><p>For the particles having tracks, we may exploit track functors to get the corresponding track properties. For instance, the track quality is given by functor <code>TRCHI2</code>.</p>
<p>What happens if we call <code>TRCHI2(cand)</code>? Explain the result.</p>
<p>Evaluate the track quality for the first and second kaon, also independently of that retrieve (in a single line) the worst of two.</p>
<p>Then, evaluate the probability that each kaon is really a kaon (<code>PROBNNk</code>) or rather a misidentified pion (<code>PROBNNpi</code>).</p>
</div></div> </p>
<p>The usage of LoKi functors extends much further than in the interactive 
<code>GaudiPython</code> world we&apos;ve been exploring here.</p>
<p>They constitute the basis of particle filtering in the <em>selection framework</em>, 
discussed in the <a href="../second-analysis-steps/building-decays-part0.html">Building your own decay 
chain</a> 
lesson in 
<a href="../second-analysis-steps">second-analysis-steps</a>.
Selecting particles means using LoKi <em>predicates</em>, functors that give a <code>bool</code> 
output, like <code>ISBASIC</code> and <code>HASTRACK</code>.
Amongst these, a key functor is <code>in_range</code>, which returns <code>True</code> if the value 
of the given <em>function</em> functor (that is, the functor that returns a <code>double</code>) 
is within the given lower and upper limit.
It helps writing CPU-efficient functors and thus is very important when building time-critical software like trigger or stripping lines.</p>
<pre><code class="lang-python"><span class="hljs-keyword">from</span> LoKiCore.functions <span class="hljs-keyword">import</span> in_range
in_range(<span class="hljs-number">2000</span>, M, <span class="hljs-number">2014</span>)(cand)
in_range(<span class="hljs-number">1860</span>, CHILD(M, <span class="hljs-number">1</span>), <span class="hljs-number">1870</span>)(cand)
</code></pre>
<p><div class="panel panel-primary"><div class="panel-heading"><h3 class="panel-title" onclick="javascript:toggle(4368156987);" id="understanding-the-cuts-in-the-stripping-lines"><i class="fa fa-info-circle"></i> Understanding the cuts in the stripping lines<span id="heading-4368156987"></span></h3></div><div class="panel-body" id="panel-4368156987"><p>Have a look at the stripping line 
<a href="http://lhcb-release-area.web.cern.ch/LHCb-release-area/DOC/stripping/config/stripping28/charm/strippingd2hhpromptdst2d2kkline.html" target="_blank">D2hhPromptDst2D2KKLine</a> which is used in our example. Open a <code>CombineParticles/D2hhPromptDst2D2KKLine</code> section, and explain which requirements are coded in the &apos;MotherCut&apos;, &apos;DaughterCuts&apos; and &apos;CombinationCut&apos; sections. 
(More details about <code>CombineParticles</code> algorithm are explained in the <a href="../second-analysis-steps/building-decays-part1.html">lesson of second analysis steps</a>.)</p>
</div></div> </p>
<p>Additionally, LoKi functors can be used directly inside our <code>DaVinci</code> jobs to store specific bits of information in our ntuples without the need for a complicated C++-based algorithms.
This second option will be discussed in the <a href="add-tupletools.html">TupleTools and branches lesson</a>.</p>
<p><div class="panel panel-primary"><div class="panel-heading"><h3 class="panel-title" onclick="javascript:toggle(6768902315);" id="debugging-loki-functors"><i class="fa fa-info-circle"></i> Debugging LoKi functors<span id="heading-6768902315"></span></h3></div><div class="panel-body" id="panel-6768902315"><p>If you write complicated LoKi functors, typically in the context of selections, 
you need functions for debugging when things go wrong.
LoKi provides wrapper functors that evaluate a functor (or functor expression), print debugging information and return the result;
the most important of these are:</p>
<ul>
<li><code>dump1</code>, which prints the input object and returns the calculated functor value,<pre><code class="lang-python"><span class="hljs-keyword">from</span> LoKiCore.functions <span class="hljs-keyword">import</span> dump1
debug_p_components_sum = dump1(p_components_sum)
debug_p_components_sum(cand)
</code></pre>
</li>
<li><code>monitor</code> which prints the input the functor string and returns the calculated functor value,<pre><code class="lang-python"><span class="hljs-keyword">from</span> LoKiCore.functions <span class="hljs-keyword">import</span> monitor
monitor_p_components_sum = monitor(p_components_sum)
monitor_p_components_sum(cand)
</code></pre>
</li>
</ul>
</div></div> </p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="interactive-dst.html" class="navigation navigation-prev " aria-label="Previous page: Interactively exploring a DST">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="minimal-dv-job.html" class="navigation navigation-next " aria-label="Next page: Running a minimal DaVinci job locally">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Fun with LoKi Functors","level":"2.1.9","depth":2,"next":{"title":"Running a minimal DaVinci job locally","level":"2.1.10","depth":2,"path":"first-analysis-steps/minimal-dv-job.md","ref":"first-analysis-steps/minimal-dv-job.md","articles":[]},"previous":{"title":"Interactively exploring a DST","level":"2.1.8","depth":2,"path":"first-analysis-steps/interactive-dst.md","ref":"first-analysis-steps/interactive-dst.md","articles":[]},"dir":"ltr"},"config":{"plugins":["-sharing","panels@git+https://github.com/lhcb/gitbook-plugin-panels.git#master","katex-auto-render@git+https://github.com/lhcb/gitbook-plugin-katex-auto-render.git#master","collapsible-menu","otherlink"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"collapsible-menu":{},"search":{},"otherlink":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"panels":{},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"katex-auto-render":{},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","author":"The Starterkit team and contributors","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"gitbook":"*"},"file":{"path":"first-analysis-steps/loki-functors.md","mtime":"2018-05-10T07:23:57.307Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2018-05-10T07:25:46.270Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-panels/panels.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-katex-auto-render/katex.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-katex-auto-render/auto-render.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-katex-auto-render/enable-auto-render.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-collapsible-menu/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-otherlink/js/otherlink.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

