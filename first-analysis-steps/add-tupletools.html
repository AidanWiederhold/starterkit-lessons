
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>TupleTools and branches Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="The Starterkit team and contributors">
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-panels/panels.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-katex-auto-render/katex.min.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="decay-tree-fitter.html" />
    
    
    <link rel="prev" href="davinci-grid.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    The LHCb Starterkit
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.1" data-path="../CONTRIBUTING.html">
            
                <a href="../CONTRIBUTING.html">
            
                    
                    Contributing
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="./">
            
                <a href="./">
            
                    
                    First analysis steps
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.1" data-path="prerequisites.html">
            
                <a href="prerequisites.html">
            
                    
                    Pre-workshop checklist
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.2" data-path="introduction-to-course.html">
            
                <a href="introduction-to-course.html">
            
                    
                    Goals of the course
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.3" data-path="dataflow.html">
            
                <a href="dataflow.html">
            
                    
                    The LHCb data flow
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.4" data-path="run-2-data-flow.html">
            
                <a href="run-2-data-flow.html">
            
                    
                    Changes to the data flow in Run 2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.5" data-path="davinci.html">
            
                <a href="davinci.html">
            
                    
                    An introduction to LHCb Software
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.6" data-path="bookkeeping.html">
            
                <a href="bookkeeping.html">
            
                    
                    Finding data in the Bookkeeping
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.7" data-path="files-from-grid.html">
            
                <a href="files-from-grid.html">
            
                    
                    Downloading a file from the grid
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.8" data-path="interactive-dst.html">
            
                <a href="interactive-dst.html">
            
                    
                    Interactively exploring a DST
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.9" data-path="loki-functors.html">
            
                <a href="loki-functors.html">
            
                    
                    Fun with LoKi Functors
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.10" data-path="minimal-dv-job.html">
            
                <a href="minimal-dv-job.html">
            
                    
                    Running a minimal DaVinci job locally
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.11" data-path="davinci-grid.html">
            
                <a href="davinci-grid.html">
            
                    
                    Running DaVinci on the grid
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="2.1.12" data-path="add-tupletools.html">
            
                <a href="add-tupletools.html">
            
                    
                    TupleTools and branches
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.13" data-path="decay-tree-fitter.html">
            
                <a href="decay-tree-fitter.html">
            
                    
                    How do I use DecayTreeFitter?
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.14" data-path="ganga-data.html">
            
                <a href="ganga-data.html">
            
                    
                    More Ganga
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.15" data-path="eos-storage.html">
            
                <a href="eos-storage.html">
            
                    
                    Storing large files on EOS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.16" data-path="split-jobs.html">
            
                <a href="split-jobs.html">
            
                    
                    Splitting a job into subjobs
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.17" data-path="lhcb-dev.html">
            
                <a href="lhcb-dev.html">
            
                    
                    Developing LHCb Software
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.18" data-path="asking-questions.html">
            
                <a href="asking-questions.html">
            
                    
                    Asking good questions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.19" data-path="ecgd.html">
            
                <a href="ecgd.html">
            
                    
                    Early career, gender and diversity
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.20" data-path="contributing-lesson.html">
            
                <a href="contributing-lesson.html">
            
                    
                    Contribute to this lesson
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../second-analysis-steps/">
            
                <a href="../second-analysis-steps/">
            
                    
                    Second analysis steps
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.1" data-path="../second-analysis-steps/lb-git.html">
            
                <a href="../second-analysis-steps/lb-git.html">
            
                    
                    Using git to develop LHCb software
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.2" data-path="../second-analysis-steps/building-decays.html">
            
                <a href="../second-analysis-steps/building-decays.html">
            
                    
                    Building your own decay
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.2.1" data-path="../second-analysis-steps/building-decays-part0.html">
            
                <a href="../second-analysis-steps/building-decays-part0.html">
            
                    
                    The Selection Framework
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.2.2" data-path="../second-analysis-steps/building-decays-part1.html">
            
                <a href="../second-analysis-steps/building-decays-part1.html">
            
                    
                    A Historical Approach
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.2.3" data-path="../second-analysis-steps/building-decays-part2.html">
            
                <a href="../second-analysis-steps/building-decays-part2.html">
            
                    
                    Modern Selection Framework
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.3" data-path="../second-analysis-steps/fixing-errors.html">
            
                <a href="../second-analysis-steps/fixing-errors.html">
            
                    
                    What to do when something fails
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4" data-path="../second-analysis-steps/rerun-stripping.html">
            
                <a href="../second-analysis-steps/rerun-stripping.html">
            
                    
                    Run a different stripping line on simulated data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.5" data-path="../second-analysis-steps/switch-mass-hypo.html">
            
                <a href="../second-analysis-steps/switch-mass-hypo.html">
            
                    
                    Replace a mass hypothesis
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6" data-path="../second-analysis-steps/filter-in-trees.html">
            
                <a href="../second-analysis-steps/filter-in-trees.html">
            
                    
                    Reuse particles from a decay tree
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.7" data-path="../second-analysis-steps/simulation.html">
            
                <a href="../second-analysis-steps/simulation.html">
            
                    
                    The simulation framework
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.7.1" data-path="../second-analysis-steps/simulation-intro.html">
            
                <a href="../second-analysis-steps/simulation-intro.html">
            
                    
                    Introduction: The basics of Gauss
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.7.2" data-path="../second-analysis-steps/simulation-running-gauss.html">
            
                <a href="../second-analysis-steps/simulation-running-gauss.html">
            
                    
                    Getting the correct option files
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.7.3" data-path="../second-analysis-steps/simulation-dkfiles.html">
            
                <a href="../second-analysis-steps/simulation-dkfiles.html">
            
                    
                    Controlling the decay
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.7.4" data-path="../second-analysis-steps/simulation-advanced-dkfiles.html">
            
                <a href="../second-analysis-steps/simulation-advanced-dkfiles.html">
            
                    
                    Advanced: Controlling the decay
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.7.5" data-path="../second-analysis-steps/simulation-gencuts.html">
            
                <a href="../second-analysis-steps/simulation-gencuts.html">
            
                    
                    Modifying generator cuts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.7.6" data-path="../second-analysis-steps/simulation-fastsim.html">
            
                <a href="../second-analysis-steps/simulation-fastsim.html">
            
                    
                    Fast simulation options
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.8" data-path="../second-analysis-steps/hlt-intro.html">
            
                <a href="../second-analysis-steps/hlt-intro.html">
            
                    
                    HLT intro
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.9" data-path="../second-analysis-steps/tistos-diy.html">
            
                <a href="../second-analysis-steps/tistos-diy.html">
            
                    
                    TisTos DIY
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.10" data-path="../second-analysis-steps/ganga-scripting.html">
            
                <a href="../second-analysis-steps/ganga-scripting.html">
            
                    
                    Ganga Scripting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.11" data-path="../second-analysis-steps/managing-files-with-ganga.html">
            
                <a href="../second-analysis-steps/managing-files-with-ganga.html">
            
                    
                    Managing files in Ganga
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.12" data-path="../second-analysis-steps/analysis-automation-snakemake.html">
            
                <a href="../second-analysis-steps/analysis-automation-snakemake.html">
            
                    
                    Analysis automation: snakemake
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="../self-guided-lessons/">
            
                <a href="../self-guided-lessons/">
            
                    
                    Self guided lessons
            
                </a>
            

            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="5.1" >
            
                <a target="_blank" href="ref://starterkit-lessons.pdf">
            
                    
                    Download PDF
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >TupleTools and branches</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="tupletools-and-branches">TupleTools and branches</h1>
<p><div class="panel panel-warning"><div class="panel-heading"><h3 class="panel-title" onclick="javascript:toggle(7155599705);" id="learning-objectives"><i class="fa fa-line-chart"></i> Learning Objectives<span id="heading-7155599705"></span></h3></div><div class="panel-body" id="panel-7155599705"><ul>
<li>Add extra TupleTools to the default DecayTreeTuple</li>
<li>Configure the extra TupleTools</li>
<li>Use branches</li>
<li>Find useful TupleTools</li>
<li>Learn how to use LoKi functors in a DecayTreeTuple</li>
</ul>
</div></div> </p>
<p>Usually, the default information stored by <code>DecayTreeTuple</code> as shown in our <a href="minimal-dv-job.html">minimal DaVinci job</a> is not enough for physics analysis.
Fortunately, most of the information we need can be added by adding C++ tools (known as <code>TupleTools</code>) to <code>dtt</code>;
there is an extensive library of these, some of which will be briefly discussed during the lesson.</p>
<p><div class="panel panel-primary"><div class="panel-heading"><h3 class="panel-title" onclick="javascript:toggle(8175287028);" id="default-decaytreetuple-tools"><i class="fa fa-info-circle"></i> Default DecayTreeTuple tools<span id="heading-8175287028"></span></h3></div><div class="panel-body" id="panel-8175287028"><p>The default tools added in <code>DecayTreeTuple</code> are:</p>
<ul>
<li><code>TupleToolKinematic</code>, which fills the kinematic information of the decay.</li>
<li><code>TupleToolPid</code>, which stores DLL and PID information of the particle.</li>
<li><code>TupleToolANNPID</code>, which stores the new NeuralNet-based PID information of the particle.</li>
<li><code>TupleToolGeometry</code>, which stores the geometrical variables (IP, vertex position, etc) of the particle.</li>
<li><code>TupleToolEventInfo</code>, which stores general information (event number, run number, GPS time, etc) of the event.</li>
</ul>
</div></div> </p>
<p>In order to add <code>TupleTools</code> to <code>dtt</code>, we have to use the <code>addTupleTool</code> method of <code>DecayTreeTuple</code> (only available when we have <code>from DecayTreeTuple.Configuration import *</code> in our script).
This method instantiates the tool, adds it to the list of tools to execute and returns it.
For example, if we want to fill the tracking information of our particles, we can add the <code>TupleToolTrackInfo</code> tool in the following way:</p>
<pre><code class="lang-python">track_tool = dtt.addTupleTool(<span class="hljs-string">&apos;TupleToolTrackInfo&apos;</span>)
</code></pre>
<p>Some tools can be configured. For example, if we wanted further information from the tracks, such as the number of degrees of freedom of the track fit, we would have to turn on the verbose mode of the tool:</p>
<pre><code class="lang-python">track_tool.Verbose = <span class="hljs-keyword">True</span>
</code></pre>
<p>If we don&apos;t need to configure the tool or we want to use the defaults, there&apos;s no need for storing the returned tool in a variable.
For example, if we wanted the information of the PV associated to our particle, we could just add the <code>TupleToolPrimaries</code> with no further configuration:</p>
<pre><code class="lang-python">dtt.addTupleTool(<span class="hljs-string">&apos;TupleToolPrimaries&apos;</span>)
</code></pre>
<p>The way the <code>DecayTreeTuple.Decay</code> is written in in our <a href="minimal-dv-job.html">minimal DaVinci job</a>,</p>
<pre><code class="lang-python">dtt.Decay = <span class="hljs-string">&apos;[D*(2010)+ -&gt; (D0 -&gt; K- K+) pi+]CC&apos;</span>
</code></pre>
<p>means that the configured <code>TupleTools</code> will only run on the head of the decay chain, that is, the <code>D*(2010)+</code>.
In order to select the particles for which we want the information stored, we need to mark them with a <code>^</code> symbol in the decay descriptor.
For example, if we want to fill the information of the <code>D0</code> and its children, as well as the soft <code>pi+</code>, we would modify the above line to look like this:</p>
<pre><code class="lang-python">dtt.Decay = <span class="hljs-string">&apos;[D*(2010)+ -&gt; ^(D0 -&gt; ^K- ^K+) ^pi+]CC&apos;</span>
</code></pre>
<p>This will run all the configured <code>TupleTools</code> on the marked particles, with the caveat that some tools are only run on certain types of particles (eg, tracking tools on particles that have an associated track).
This configuration is not optimal, since there may be tools which we only want to run on the D&apos;s and some only on the children. Enter <code>Branches</code>, which allow us to specify which tools get applied to which particle in the decay (in addition to the <code>TupleTools</code> configured at the top level).</p>
<p><em>Branches</em> let you define custom namespaces in your ntuple by means of a <code>dict</code>.
Its keys define the name of each branch (and, as a consequence, the prefix of the corresponding leaves in the ntuple), while the corresponding values are decay descriptors that specify which particles you want to include in the branch.</p>
<pre><code class="lang-python">dtt.addBranches({<span class="hljs-string">&apos;Dstar&apos;</span> : <span class="hljs-string">&apos;[D*(2010)+ -&gt; (D0 -&gt; K- K+) pi+]CC&apos;</span>,
                 <span class="hljs-string">&apos;D0&apos;</span>    : <span class="hljs-string">&apos;[D*(2010)+ -&gt; ^(D0 -&gt; K- K+) pi+]CC&apos;</span>,
                 <span class="hljs-string">&apos;Kminus&apos;</span>: <span class="hljs-string">&apos;[D*(2010)+ -&gt; (D0 -&gt; ^K- K+) pi+]CC&apos;</span>,
                 <span class="hljs-string">&apos;Kplus&apos;</span> : <span class="hljs-string">&apos;[D*(2010)+ -&gt; (D0 -&gt; K- ^K+) pi+]CC&apos;</span>,
                 <span class="hljs-string">&apos;pisoft&apos;</span>: <span class="hljs-string">&apos;[D*(2010)+ -&gt; (D0 -&gt; K- K+) ^pi+]CC&apos;</span>})
</code></pre>
<p>Note that in order to use branches, we have to make sure that all particles we want to use are marked in the main decay descriptor (<code>dtt.Decay</code>).
DaVinci will ignore branches for particles that have not been marked in <code>dtt.Decay</code>!</p>
<p>Once the branches have been configured, they can be accessed as <code>dtt.PARTICLENAME</code>and <code>TupleTools</code> can be added as discussed before.
For example, if we want to store the proper time information of the D0, we would do</p>
<pre><code class="lang-python">dtt.D0.addTupleTool(<span class="hljs-string">&apos;TupleToolPropertime&apos;</span>)
</code></pre>
<p><div class="panel panel-primary"><div class="panel-heading"><h3 class="panel-title" onclick="javascript:toggle(8388243645);" id="do-i-really-have-to-type-my-decay-descriptor-that-many-times"><i class="fa fa-info-circle"></i> Do I really have to type my decay descriptor that many times?<span id="heading-8388243645"></span></h3></div><div class="panel-body" id="panel-8388243645"><p>No! You can use the (new) <code>dtt.setDescriptorTemplate()</code> method to set up your 
decay descriptor and branches in just one line!
Well, nearly: because this is a new feature it is not available in most released versions of <code>DaVinci</code>, but <a href="https://gitlab.cern.ch/snippets/147" target="_blank">this snippet</a> will add it to an older version.
With that out of the way, you can simply use</p>
<pre><code class="lang-python">dtt.setDescriptorTemplate(<span class="hljs-string">&apos;${Dstar}[D*(2010)+ -&gt; ${D0}(D0 -&gt; ${Kminus}K- ${Kplus}K+) ${pisoft}pi+]CC&apos;</span>)
</code></pre>
<p>This will set up both <code>dtt.Decay</code> and <code>Branches</code> for you.</p>
</div></div> </p>
<p>The usage of <code>Branches</code> is very important (and strongly encouraged) to keep the size of your ntuples small, since it prevents us from storing unneeded information (for example trigger information, which will be discussed at a later lesson).</p>
<p><div class="panel panel-primary"><div class="panel-heading"><h3 class="panel-title" onclick="javascript:toggle(4636632595);" id="where-to-find-tupletools"><i class="fa fa-info-circle"></i> Where to find TupleTools<span id="heading-4636632595"></span></h3></div><div class="panel-body" id="panel-4636632595"><p>One of the most difficult things is to know which tool we need to add to our 
<code>DecayTreeTuple</code> in order to get the information we want.
For this, it is necessary to know where to find <code>TupleTools</code> and their code.
<code>TupleTools</code> are spread in 9 packages under <code>Analysis/Phys</code> (see the master branch in <code>git</code> <a href="https://gitlab.cern.ch/lhcb/Analysis/tree/master/Phys" target="_blank">here</a>), all starting with the prefix <code>DecayTreeTuple</code>, according to the type of information they fill in our ntuple:</p>
<ul>
<li><code>DecayTreeTuple</code> for the more general tools.</li>
<li><code>DecayTreeTupleANNPID</code> for the NeuralNet-based PID tools.</li>
<li><code>DecayTreeTupleDalitz</code> for Dalitz analysis.</li>
<li><code>DecayTreeTupleJets</code> for obtaining information on jets.</li>
<li><code>DecayTreeTupleMC</code> gives us access to MC-level information.</li>
<li><code>DecayTreeTupleMuonCalib</code> for muon calibration tools.</li>
<li><code>DecayTreeTupleReco</code> for reconstruction-level information, such as <code>TupleToolTrackInfo</code>.</li>
<li><code>DecayTreeTupleTracking</code> for more detailed tools regarding tracking.</li>
<li><code>DecayTreeTupleTrigger</code> for accessing to the trigger information of the candidates.</li>
</ul>
<p>The <code>TupleTools</code> are placed in the <code>src</code> folder within each package and it&apos;s usually easy to get what they do just by looking at their name.
However, the best way to know what a tool does is check its documentation, either by opening its <code>.h</code> file or be searching for it in the latest <a href="http://lhcb-release-area.web.cern.ch/LHCb-release-area/DOC/davinci/releases/latest/doxygen/index.html" target="_blank"><code>doxygen</code></a>.
Most tools are very well documented and will also inform you of their configuration options.
As an example, to get the information on the <code>TupleToolTrackInfo</code> we used before we could either check its <a href="https://gitlab.cern.ch/lhcb/Analysis/blob/master/Phys/DecayTreeTupleReco/src/TupleToolTrackInfo.h" target="_blank">source code</a> or its <a href="http://lhcb-release-area.web.cern.ch/LHCb-release-area/DOC/analysis/releases/latest/doxygen/da/ddd/class_tuple_tool_track_info.html" target="_blank">web documentation</a>.
 In case we need more information or need to know <em>exactly</em> what the code does, the <code>fill</code> method is the one we need to look at.</p>
<p> As a shortcut, the list of tupletools can also be found in doxygen at the top of the pages for the <a href="http://lhcb-release-area.web.cern.ch/LHCb-release-area/DOC/davinci/releases/latest/doxygen/d1/d77/class_i_particle_tuple_tool.html" target="_blank"><code>IParticleTupleTool</code></a> and the <a href="http://lhcb-release-area.web.cern.ch/LHCb-release-area/DOC/davinci/releases/latest/doxygen/d7/d5c/class_i_event_tuple_tool.html" target="_blank"><code>IEventTupleTool</code></a> interfaces (depending on whether they fill information about specific particles or the event in general).</p>
</div></div> </p>
<p>The updated options can be found <a href="code/add-tupletools/ntuple_options.py">here</a>.</p>
<p><div class="panel panel-success"><div class="panel-heading"><h3 class="panel-title" onclick="javascript:toggle(5524565070);" id="test-your-ntuple"><i class="fa fa-square-o"></i> Test your ntuple<span id="heading-5524565070"></span></h3></div><div class="panel-body" id="panel-5524565070"><p>Run the options in the same way as in the <a href="minimal-dv-job.html">minimal DaVinci 
job</a> lesson.
You will obtain a <code>DVntuple.root</code> file, which we can open and inspect with <code>ROOT</code>&apos;s <code>TBrowser</code>:</p>
<pre><code>$ root DVntuple.root
root [0]
Attaching file DVntuple.root as _file0...
root [1] TBrowser b
root [2]
</code></pre><p>Try to locate the branches we have added, which are placed in the <code>TupleDstToD0pi_D0ToKpi/DecayTree</code>, and plot some distributions by double-clicking the leaves.</p>
</div></div> </p>
<p>Picking up with the <a href="loki-functors.html">LoKi functors lesson</a>, let&apos;s store some specific bits of information discussed there in our ntuple.
To add LoKi-based leaves to the tree, we need to use the <code>LoKi::Hybrid::TupleTool</code>, which is configured with 3 arguments:</p>
<ol>
<li>Its <em>name</em>, specified in the <code>addTupleTool</code> call after a <code>/</code>.  This is 
very useful (and recommended) if we want to have different 
<code>LoKi::Hybrid::TupleTool</code> for each of our branches. For instance, we may 
want to add different information for the D*, the D0 and the soft $$\pi$$:<pre><code class="lang-python">dstar_hybrid = dtt.Dstar.addTupleTool(<span class="hljs-string">&apos;LoKi::Hybrid::TupleTool/LoKi_Dstar&apos;</span>)
d0_hybrid = dtt.D0.addTupleTool(<span class="hljs-string">&apos;LoKi::Hybrid::TupleTool/LoKi_D0&apos;</span>)
pisoft_hybrid = dtt.pisoft.addTupleTool(<span class="hljs-string">&apos;LoKi::Hybrid::TupleTool/LoKi_PiSoft&apos;</span>)
</code></pre>
</li>
<li>The <code>Preambulo</code> property, which lets us perform preprocessing of the LoKi 
functors to simplify the code that is used to fill the leaves, for example 
creating combinations of LoKi functors or performing mathematical 
operations:<pre><code class="lang-python">preamble = [
   <span class="hljs-string">&apos;DZ = VFASPF(VZ) - BPV(VZ)&apos;</span>,
   <span class="hljs-string">&apos;TRACK_MAX_PT = MAXTREE(ISBASIC &amp; HASTRACK, PT, -1)&apos;</span>
]
dstar_hybrid.Preambulo = preamble
d0_hybrid.Preambulo = preamble
</code></pre>
</li>
<li>The <code>Variables</code> property, consisting of a <code>dict</code> of (variable name, LoKi 
functor) pairs. In here, LoKi functors can be used, as well as any 
variable we may have defined in the <code>Preambulo</code>:<pre><code class="lang-python">dstar_hybrid.Variables = {
   <span class="hljs-string">&apos;mass&apos;</span>: <span class="hljs-string">&apos;M&apos;</span>,
   <span class="hljs-string">&apos;mass_D0&apos;</span>: <span class="hljs-string">&apos;CHILD(M, 1)&apos;</span>,
   <span class="hljs-string">&apos;pt&apos;</span>: <span class="hljs-string">&apos;PT&apos;</span>,
   <span class="hljs-string">&apos;dz&apos;</span>: <span class="hljs-string">&apos;DZ&apos;</span>,
   <span class="hljs-string">&apos;dira&apos;</span>: <span class="hljs-string">&apos;BPVDIRA&apos;</span>,
   <span class="hljs-string">&apos;max_pt&apos;</span>: <span class="hljs-string">&apos;MAXTREE(ISBASIC &amp; HASTRACK, PT, -1)&apos;</span>,
   <span class="hljs-string">&apos;max_pt_preambulo&apos;</span>: <span class="hljs-string">&apos;TRACK_MAX_PT&apos;</span>,
   <span class="hljs-string">&apos;sum_pt_pions&apos;</span>: <span class="hljs-string">&apos;SUMTREE(211 == ABSID, PT)&apos;</span>,
   <span class="hljs-string">&apos;n_highpt_tracks&apos;</span>: <span class="hljs-string">&apos;NINTREE(ISBASIC &amp; HASTRACK &amp; (PT &gt; 1500*MeV))&apos;</span>
}
d0_hybrid.Variables = {
   <span class="hljs-string">&apos;mass&apos;</span>: <span class="hljs-string">&apos;M&apos;</span>,
   <span class="hljs-string">&apos;pt&apos;</span>: <span class="hljs-string">&apos;PT&apos;</span>,
   <span class="hljs-string">&apos;dira&apos;</span>: <span class="hljs-string">&apos;BPVDIRA&apos;</span>,
   <span class="hljs-string">&apos;vtx_chi2&apos;</span>: <span class="hljs-string">&apos;VFASPF(VCHI2)&apos;</span>,
   <span class="hljs-string">&apos;dz&apos;</span>: <span class="hljs-string">&apos;DZ&apos;</span>
}
pisoft_hybrid.Variables = {
   <span class="hljs-string">&apos;p&apos;</span>: <span class="hljs-string">&apos;P&apos;</span>,
   <span class="hljs-string">&apos;pt&apos;</span>: <span class="hljs-string">&apos;PT&apos;</span>
}
</code></pre>
</li>
</ol>
<p>In the code snippets specified above (available <a href="code/add-tupletools/ntuple_options_loki.py">here</a>), you can see that the <code>NINTREE</code> functor counts the number of particles that pass the specified criteria. While this is not very useful for ntuple-building (we can always do it offline), it&apos;s a very powerful functor to use when building decay selections.</p>
<p><div class="panel panel-success"><div class="panel-heading"><h3 class="panel-title" onclick="javascript:toggle(1352171675);" id="getting-more-practice"><i class="fa fa-square-o"></i> Getting more practice<span id="heading-1352171675"></span></h3></div><div class="panel-body" id="panel-1352171675"><p>In the <code>LoKi::Hybrid::TupleTool</code>we&apos;ve used some  functors that have not been 
described previously. Find out what they do in the 
<a href="http://lhcb-release-area.web.cern.ch/LHCb-release-area/DOC/davinci/latest_doxygen/d7/dae/namespace_lo_ki_1_1_cuts.html" target="_blank">doxygen</a>.
To check <code>SUMTREE</code> and <code>CHILD</code>, run the code above and check that the <code>Dstar_max_pt</code> and <code>Dstar_max_pt_preambulo</code> and the <code>Dstar_mass_D0</code> and <code>D0_mass</code> branches have exactly the same values.</p>
</div></div> </p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="davinci-grid.html" class="navigation navigation-prev " aria-label="Previous page: Running DaVinci on the grid">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="decay-tree-fitter.html" class="navigation navigation-next " aria-label="Next page: How do I use DecayTreeFitter?">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"TupleTools and branches","level":"2.1.12","depth":2,"next":{"title":"How do I use DecayTreeFitter?","level":"2.1.13","depth":2,"path":"first-analysis-steps/decay-tree-fitter.md","ref":"first-analysis-steps/decay-tree-fitter.md","articles":[]},"previous":{"title":"Running DaVinci on the grid","level":"2.1.11","depth":2,"path":"first-analysis-steps/davinci-grid.md","ref":"first-analysis-steps/davinci-grid.md","articles":[]},"dir":"ltr"},"config":{"plugins":["-sharing","panels@git+https://github.com/lhcb/gitbook-plugin-panels.git#master","katex-auto-render@git+https://github.com/lhcb/gitbook-plugin-katex-auto-render.git#master","collapsible-menu","otherlink"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"collapsible-menu":{},"search":{},"otherlink":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"panels":{},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"katex-auto-render":{},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","author":"The Starterkit team and contributors","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"gitbook":"*"},"file":{"path":"first-analysis-steps/add-tupletools.md","mtime":"2018-11-22T16:45:09.898Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2018-11-22T16:46:32.112Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-panels/panels.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-katex-auto-render/katex.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-katex-auto-render/auto-render.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-katex-auto-render/enable-auto-render.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-collapsible-menu/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-otherlink/js/otherlink.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

